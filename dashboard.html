<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MyAccurate Books</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }
        
        .login-box h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .login-box button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-box button:hover {
            transform: translateY(-2px);
        }
        
        .login-box button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Dashboard */
        .dashboard {
            display: none;
        }
        
        .dashboard-header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dashboard-header h1 {
            color: #333;
            font-size: 24px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .user-info {
            color: #666;
            font-size: 14px;
        }
        
        .logout-btn {
            padding: 8px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .dashboard-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            padding: 15px 30px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: #f8f9fa;
            color: #667eea;
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-left: 4px solid #764ba2;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            background: #f5f6fa;
            overflow-y: auto;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Filter Section */
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-active {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-standard {
            background: #cfe2ff;
            color: #084298;
        }
        
        .badge-gold {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1>Admin Dashboard</h1>
            <p>MyAccurate Books Administration</p>
            <button onclick="adminLogin()" id="loginBtn">Login as Administrator</button>
            <div id="loginMessage" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="dashboard">
        <div class="dashboard-header">
            <h1>MyAccurate Books Dashboard</h1>
            <div class="header-actions">
                <span class="user-info">Admin User</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <div class="sidebar">
                <div class="nav-item active" onclick="showSection('overview')">
                    üìä Overview
                </div>
                <div class="nav-item" onclick="showSection('businesses')">
                    üè¢ Businesses
                </div>
                <div class="nav-item" onclick="showSection('subscriptions')">
                    üìã Subscriptions
                </div>
                <div class="nav-item" onclick="showSection('payments')">
                    üí∞ Payments
                </div>
                <div class="nav-item" onclick="showSection('logs')">
                    üìù General Logs
                </div>
                <div class="nav-item" onclick="showSection('loginLogs')">
                    üîê Login Logs
                </div>
            </div>
            
            <div class="main-content">
                <!-- Overview Section -->
                <div id="overview" class="section active">
                    <div class="card">
                        <h2>Dashboard Overview</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="overviewTotalBusinesses">-</div>
                                <div class="stat-label">Total Businesses</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="overviewActiveBusinesses">-</div>
                                <div class="stat-label">Active Businesses</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="overviewTotalRevenue">-</div>
                                <div class="stat-label">Total Revenue</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="overviewTotalPayments">-</div>
                                <div class="stat-label">Total Payments</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadOverview()">Refresh Overview</button>
                    </div>
                </div>

                <!-- Businesses Section -->
                <div id="businesses" class="section">
                    <div class="card">
                        <h2>Business Management</h2>
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>Package Type</label>
                                <select id="businessPackageFilter">
                                    <option value="">All Packages</option>
                                    <option value="1">Package 1 (Needs Follow-up)</option>
                                    <option value="2">Package 2 (Standard)</option>
                                    <option value="3">Package 3 (Gold)</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Start Date</label>
                                <input type="date" id="businessStartDate">
                            </div>
                            <div class="filter-group">
                                <label>End Date</label>
                                <input type="date" id="businessEndDate">
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="loadBusinesses()">Load Businesses</button>
                            <button class="btn btn-success" onclick="exportBusinessData('csv')">Export CSV</button>
                        </div>
                        <div id="businessMessage"></div>
                        <div id="businessStats" style="margin-top: 20px;"></div>
                        <div class="table-container">
                            <table id="businessTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Company Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Package</th>
                                        <th>Location</th>
                                        <th>Currency</th>
                                        <th>VAT</th>
                                        <th>Created Date</th>
                                    </tr>
                                </thead>
                                <tbody id="businessTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Subscriptions Section -->
                <div id="subscriptions" class="section">
                    <div class="card">
                        <h2>Subscription Analysis</h2>
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>Filter Type</label>
                                <select id="subscriptionFilter">
                                    <option value="all_active">All Active</option>
                                    <option value="expiring_today">Expiring Today</option>
                                    <option value="expiring_this_week">Expiring This Week</option>
                                    <option value="expiring_this_month">Expiring This Month</option>
                                    <option value="expired_this_month">Expired This Month</option>
                                    <option value="unpaid_only">Unpaid Only</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadSubscriptions()">Analyze Subscriptions</button>
                        <button class="btn btn-success" onclick="exportSubscriptions()" style="margin-left: 10px;">Export to Excel</button>
                        <div id="subscriptionMessage"></div>
                        <div id="subscriptionStats"></div>
                        <div class="table-container">
                            <table id="subscriptionTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Business Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Package</th>
                                        <th>Status</th>
                                        <th>Payment</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Days to Expiry</th>
                                        <th>Revenue</th>
                                    </tr>
                                </thead>
                                <tbody id="subscriptionTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Payments Section -->
                <div id="payments" class="section">
                    <div class="card">
                        <h2>Payment Records</h2>
                        <button class="btn btn-primary" onclick="loadPayments()">Load All Payments</button>
                        <button class="btn btn-success" onclick="exportPayments()" style="margin-left: 10px;">Export to Excel</button>
                        <div id="paymentMessage"></div>
                        <div id="paymentStats"></div>
                        <div class="table-container">
                            <table id="paymentTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Business Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Transaction Count</th>
                                        <th>Total Spent</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- General Logs Section -->
                <div id="logs" class="section">
                    <div class="card">
                        <h2>General System Logs</h2>
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>Start Date & Time</label>
                                <input type="datetime-local" id="logStartDate">
                            </div>
                            <div class="filter-group">
                                <label>End Date & Time</label>
                                <input type="datetime-local" id="logEndDate">
                            </div>
                            <div class="filter-group">
                                <label>Log Type</label>
                                <input type="text" id="logType" placeholder="e.g., business_register">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadLogs()">Fetch Logs</button>
                        <button class="btn btn-success" onclick="exportLogs()" style="margin-left: 10px;">Export to Excel</button>
                        <div id="logMessage"></div>
                        <div id="logStats"></div>
                        <div class="table-container">
                            <table id="logTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Business Name</th>
                                        <th>Email</th>
                                        <th>Parent ID</th>
                                        <th>Timestamp</th>
                                        <th>Response Time</th>
                                        <th>Path</th>
                                        <th>Method</th>
                                    </tr>
                                </thead>
                                <tbody id="logTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Login Logs Section -->
                <div id="loginLogs" class="section">
                    <div class="card">
                        <h2>Login Activity Logs</h2>
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>Start Date & Time</label>
                                <input type="datetime-local" id="loginLogStartDate">
                            </div>
                            <div class="filter-group">
                                <label>End Date & Time</label>
                                <input type="datetime-local" id="loginLogEndDate">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadLoginLogs()">Fetch Login Logs</button>
                        <button class="btn btn-success" onclick="exportLoginLogs()" style="margin-left: 10px;">Export to Excel</button>
                        <div id="loginLogMessage"></div>
                        <div id="loginLogStats"></div>
                        <div class="table-container">
                            <table id="loginLogTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Message</th>
                                        <th>Timestamp</th>
                                        <th>IP Address</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody id="loginLogTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://core.myaccuratebook.com';
        const AUTH_TOKEN = 'zWWq5BWO+anUMgWtimvvCguXwU=wAMnzI6grv9WkCFsIdkBydGV4SDZQQHNz';
        let adminToken = null;
        let currentBusinesses = [];

        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message message-${type}">${message}</div>`;
        }

        function clearMessage(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // Login using PHP backend
        async function adminLogin() {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            
            try {
                const response = await fetch('analyze_subscriptions.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'login'
                    })
                });

                const data = await response.json();
                
                if (data.success && data.token) {
                    adminToken = data.token;
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboardPage').style.display = 'block';
                    loadOverview();
                } else {
                    showMessage('loginMessage', 'Login failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('loginMessage', 'Login error: ' + error.message, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login as Administrator';
            }
        }

        function logout() {
            adminToken = null;
            document.getElementById('dashboardPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadOverview() {
            try {
                const [businessRes, paymentRes] = await Promise.all([
                    fetch(`${BASE_URL}/admin/business-stats?token=${adminToken}`, {
                        headers: { 'Authorization': AUTH_TOKEN }
                    }),
                    fetch(`${BASE_URL}/admin/getAllSubscriptionPaymnets?token=${adminToken}`, {
                        headers: { 'Authorization': AUTH_TOKEN }
                    })
                ]);

                const businessData = await businessRes.json();
                const paymentData = await paymentRes.json();

                document.getElementById('overviewTotalBusinesses').textContent = businessData.totalBusinesses || 0;
                document.getElementById('overviewActiveBusinesses').textContent = businessData.activeBusinesses?.count || 0;
                document.getElementById('overviewTotalRevenue').textContent = `KSH ${paymentData.data?.summary?.totalRevenue?.toLocaleString() || 0}`;
                document.getElementById('overviewTotalPayments').textContent = paymentData.data?.summary?.totalTransactions || 0;
            } catch (error) {
                console.error('Overview load error:', error);
            }
        }

        async function loadBusinesses() {
            clearMessage('businessMessage');
            showMessage('businessMessage', 'Loading businesses... This may take a moment.', 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
                
                const response = await fetch(`${BASE_URL}/admin/business-stats?token=${adminToken}`, {
                    headers: { 'Authorization': AUTH_TOKEN },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to load businesses');
                }

                currentBusinesses = data.activeBusinesses?.rows || [];
                
                if (currentBusinesses.length === 0) {
                    showMessage('businessMessage', 'No businesses found or API returned empty data. Check your connection.', 'error');
                    return;
                }
                
                let filtered = [...currentBusinesses];
                const packageFilter = document.getElementById('businessPackageFilter').value;
                const startDate = document.getElementById('businessStartDate').value;
                const endDate = document.getElementById('businessEndDate').value;

                if (packageFilter) {
                    filtered = filtered.filter(b => b.packageId == packageFilter);
                }

                if (startDate) {
                    filtered = filtered.filter(b => new Date(b.createdAt) >= new Date(startDate));
                }

                if (endDate) {
                    filtered = filtered.filter(b => new Date(b.createdAt) <= new Date(endDate));
                }

                displayBusinesses(filtered);
                showMessage('businessMessage', `Loaded ${filtered.length} businesses successfully`, 'success');
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('businessMessage', 'Request timed out. The server took too long to respond. Try again or contact support.', 'error');
                } else {
                    showMessage('businessMessage', 'Error: ' + error.message, 'error');
                }
            }
        }

        function displayBusinesses(businesses) {
            const tbody = document.getElementById('businessTableBody');
            const table = document.getElementById('businessTable');
            
            tbody.innerHTML = '';
            
            businesses.forEach(b => {
                const packageName = b.packageId === 1 ? 'Needs Follow-up' : b.packageId === 2 ? 'Standard' : 'Gold';
                const packageClass = b.packageId === 1 ? 'badge-inactive' : b.packageId === 2 ? 'badge-standard' : 'badge-gold';
                
                const row = `
                    <tr>
                        <td>${b.company_name || 'N/A'}</td>
                        <td>${b.company_email || 'N/A'}</td>
                        <td>${b.phone_number || 'N/A'}</td>
                        <td><span class="badge ${packageClass}">${packageName}</span></td>
                        <td>${b.Business_location || 'N/A'}</td>
                        <td>${b.currency || 'N/A'}</td>
                        <td>${b.is_vat ? '‚úì' : '‚úó'}</td>
                        <td>${new Date(b.createdAt).toLocaleDateString()}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            table.style.display = businesses.length > 0 ? 'table' : 'none';

            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${businesses.length}</div>
                        <div class="stat-label">Total Businesses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${businesses.filter(b => b.packageId === 2).length}</div>
                        <div class="stat-label">Standard Package</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${businesses.filter(b => b.packageId === 3).length}</div>
                        <div class="stat-label">Gold Package</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${businesses.filter(b => b.packageId === 1).length}</div>
                        <div class="stat-label">Needs Follow-up</div>
                    </div>
                </div>
            `;
            document.getElementById('businessStats').innerHTML = stats;
        }

        function exportBusinessData(format) {
            if (currentBusinesses.length === 0) {
                alert('No data to export. Please load businesses first.');
                return;
            }

            let csv = 'Company Name,Email,Phone,Package,Location,Currency,VAT,Created Date\n';
            currentBusinesses.forEach(b => {
                const packageName = b.packageId === 1 ? 'Needs Follow-up' : b.packageId === 2 ? 'Standard' : 'Gold';
                const row = [
                    b.company_name || '',
                    b.company_email || '',
                    b.phone_number || '',
                    packageName,
                    b.Business_location || '',
                    b.currency || '',
                    b.is_vat ? 'Yes' : 'No',
                    new Date(b.createdAt).toLocaleDateString()
                ];
                csv += '"' + row.join('","') + '"\n';
            });

            downloadCSV(csv, `businesses_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Global variables for export
        let currentSubscriptionData = null;
        let currentPaymentData = null;
        let currentLogData = null;
        let currentLoginLogData = null;

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportSubscriptions() {
            if (!currentSubscriptionData || !currentSubscriptionData.subscriptions) {
                alert('No subscription data to export. Please load subscriptions first.');
                return;
            }

            let csv = 'Business Name,Email,Phone,Package,Status,Payment Status,Start Date,End Date,Days to Expiry,Revenue\n';
            currentSubscriptionData.subscriptions.forEach(sub => {
                const row = [
                    sub.businessName || '',
                    sub.businessEmail || '',
                    sub.phoneNumber || '',
                    sub.packageName || '',
                    sub.subscriptionStatus || '',
                    sub.paymentStatus || '',
                    sub.startDate || '',
                    sub.endDate || '',
                    sub.daysUntilExpiry !== 'N/A' ? sub.daysUntilExpiry : '',
                    sub.revenue || '0'
                ];
                csv += '"' + row.join('","') + '"\n';
            });

            downloadCSV(csv, `subscriptions_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportPayments() {
            if (!currentPaymentData) {
                alert('No payment data to export. Please load payments first.');
                return;
            }

            const customers = currentPaymentData.topCustomers?.byTransactionCount || [];
            let csv = 'Business Name,Email,Phone,Transaction Count,Total Spent\n';
            customers.forEach(c => {
                const row = [
                    c.businessName || '',
                    c.email || '',
                    c.phone || '',
                    c.transactionCount || '0',
                    c.totalSpent || '0'
                ];
                csv += '"' + row.join('","') + '"\n';
            });

            downloadCSV(csv, `payments_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportLogs() {
            if (!currentLogData || !currentLogData.businessAnalytics) {
                alert('No log data to export. Please load logs first.');
                return;
            }

            let csv = 'Business Name,Email,Last Seen\n';
            currentLogData.businessAnalytics.forEach(b => {
                const row = [
                    b.name || '',
                    b.email || '',
                    b.lastSeenEAT || ''
                ];
                csv += '"' + row.join('","') + '"\n';
            });

            downloadCSV(csv, `logs_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportLoginLogs() {
            if (!currentLoginLogData) {
                alert('No login log data to export. Please load login logs first.');
                return;
            }

            // Parse the HTML table data
            const tbody = document.getElementById('loginLogTableBody');
            if (!tbody || tbody.children.length === 0) {
                alert('No login log data to export.');
                return;
            }

            let csv = 'Email,Status,Message,Timestamp,IP Address,Reason\n';
            Array.from(tbody.children).forEach(row => {
                const cells = row.children;
                const rowData = [
                    cells[0]?.textContent || '',
                    cells[1]?.textContent || '',
                    cells[2]?.textContent || '',
                    cells[3]?.textContent || '',
                    cells[4]?.textContent || '',
                    cells[5]?.textContent || ''
                ];
                csv += '"' + rowData.join('","') + '"\n';
            });

            downloadCSV(csv, `login_logs_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Load subscriptions using PHP backend
        async function loadSubscriptions() {
            clearMessage('subscriptionMessage');
            showMessage('subscriptionMessage', 'Analyzing subscriptions...', 'info');
            
            try {
                const filterType = document.getElementById('subscriptionFilter').value;
                
                const response = await fetch('analyze_subscriptions.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: adminToken,
                        filterType: filterType
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                displaySubscriptions(data);
                showMessage('subscriptionMessage', `Found ${data.totalSubscriptions} subscriptions`, 'success');
            } catch (error) {
                showMessage('subscriptionMessage', 'Error: ' + error.message, 'error');
            }
        }

        function displaySubscriptions(data) {
            currentSubscriptionData = data; // Store for export
            
            const tbody = document.getElementById('subscriptionTableBody');
            const table = document.getElementById('subscriptionTable');
            
            tbody.innerHTML = data.tableRows || '';
            table.style.display = data.tableRows ? 'table' : 'none';

            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.totalSubscriptions || 0}</div>
                        <div class="stat-label">Total Subscriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.paidSubscriptions || 0}</div>
                        <div class="stat-label">Paid Subscriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.unpaidSubscriptions || 0}</div>
                        <div class="stat-label">Unpaid Subscriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">KSH ${data.totalRevenue || 0}</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                </div>
            `;
            document.getElementById('subscriptionStats').innerHTML = stats;
        }

        async function loadPayments() {
            clearMessage('paymentMessage');
            showMessage('paymentMessage', 'Loading payments...', 'info');
            
            try {
                const response = await fetch(`${BASE_URL}/admin/getAllSubscriptionPaymnets?token=${adminToken}`, {
                    headers: { 'Authorization': AUTH_TOKEN }
                });

                const data = await response.json();
                displayPayments(data.data);
                showMessage('paymentMessage', 'Payments loaded successfully', 'success');
            } catch (error) {
                showMessage('paymentMessage', 'Error: ' + error.message, 'error');
            }
        }

        function displayPayments(paymentData) {
            currentPaymentData = paymentData; // Store for export
            
            const summary = paymentData.summary || {};
            const customers = paymentData.topCustomers?.byTransactionCount || [];
            
            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${summary.totalTransactions || 0}</div>
                        <div class="stat-label">Total Transactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">KSH ${(summary.totalRevenue || 0).toLocaleString()}</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${summary.successfulPayments || 0}</div>
                        <div class="stat-label">Successful Payments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${summary.overallSuccessRate || '0%'}</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
            `;
            document.getElementById('paymentStats').innerHTML = stats;

            const tbody = document.getElementById('paymentTableBody');
            const table = document.getElementById('paymentTable');
            
            tbody.innerHTML = '';
            customers.forEach(c => {
                tbody.innerHTML += `
                    <tr>
                        <td>${c.businessName || 'N/A'}</td>
                        <td>${c.email || 'N/A'}</td>
                        <td>${c.phone || 'N/A'}</td>
                        <td>${c.transactionCount || 0}</td>
                        <td>KSH ${(c.totalSpent || 0).toLocaleString()}</td>
                    </tr>
                `;
            });

            table.style.display = customers.length > 0 ? 'table' : 'none';
        }

        // Load general logs using PHP backend
        async function loadLogs() {
            clearMessage('logMessage');
            
            const startDate = document.getElementById('logStartDate').value;
            const endDate = document.getElementById('logEndDate').value;
            const logType = document.getElementById('logType').value;

            if (!startDate || !endDate || !logType) {
                showMessage('logMessage', 'Please fill in all fields', 'error');
                return;
            }

            showMessage('logMessage', 'Fetching logs...', 'info');

            try {
                const formatDateTime = (dateTime) => {
                    const date = new Date(dateTime);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${year}${month}${day}${hours}${minutes}${seconds}`;
                };

                const formattedStartDate = formatDateTime(startDate);
                const formattedEndDate = formatDateTime(endDate);

                const formData = new FormData();
                formData.append('startDate', formattedStartDate);
                formData.append('endDate', formattedEndDate);
                formData.append('logType', logType);
                formData.append('token', adminToken);

                const response = await fetch('fetch_logs.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                displayLogs(data);
                showMessage('logMessage', `Found ${data.totalLogs} logs`, 'success');
            } catch (error) {
                showMessage('logMessage', 'Error: ' + error.message, 'error');
            }
        }

        function displayLogs(data) {
            currentLogData = data; // Store for export
            
            const tbody = document.getElementById('logTableBody');
            const table = document.getElementById('logTable');
            
            tbody.innerHTML = data.logRows || '';
            table.style.display = data.logRows ? 'table' : 'none';

            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.totalLogs || 0}</div>
                        <div class="stat-label">Total Logs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.uniqueUserCount || 0}</div>
                        <div class="stat-label">Unique Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.dateRange || 'N/A'}</div>
                        <div class="stat-label">Date Range</div>
                    </div>
                </div>
            `;
            document.getElementById('logStats').innerHTML = stats;
        }

        // Load login logs using PHP backend
        async function loadLoginLogs() {
            clearMessage('loginLogMessage');
            
            const startDate = document.getElementById('loginLogStartDate').value;
            const endDate = document.getElementById('loginLogEndDate').value;

            if (!startDate || !endDate) {
                showMessage('loginLogMessage', 'Please select both start and end dates', 'error');
                return;
            }

            showMessage('loginLogMessage', 'Fetching login logs...', 'info');

            try {
                const formatDateTime = (dateTime) => {
                    const date = new Date(dateTime);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${year}${month}${day}${hours}${minutes}${seconds}`;
                };

                const formattedStartDate = formatDateTime(startDate);
                const formattedEndDate = formatDateTime(endDate);

                const formData = new FormData();
                formData.append('startDate', formattedStartDate);
                formData.append('endDate', formattedEndDate);
                formData.append('token', adminToken);

                const response = await fetch('fetch_login_logs.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                displayLoginLogs(data);
                showMessage('loginLogMessage', `Found ${data.uniqueUserCount} unique users`, 'success');
            } catch (error) {
                showMessage('loginLogMessage', 'Error: ' + error.message, 'error');
            }
        }

        function displayLoginLogs(data) {
            currentLoginLogData = data; // Store for export
            
            const tbody = document.getElementById('loginLogTableBody');
            const table = document.getElementById('loginLogTable');
            
            tbody.innerHTML = data.logRows || '';
            table.style.display = data.logRows ? 'table' : 'none';

            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.uniqueUserCount || 0}</div>
                        <div class="stat-label">Unique Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.successfulLogins || 0}</div>
                        <div class="stat-label">Successful Logins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.failedLogins || 0}</div>
                        <div class="stat-label">Failed Logins</div>
                    </div>
                </div>
            `;
            document.getElementById('loginLogStats').innerHTML = stats;
        }
    </script>
</body>
</html>