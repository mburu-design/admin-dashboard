<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MyAccurate Books</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }
        
        .login-box h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .login-box button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-box button:hover {
            transform: translateY(-2px);
        }
        
        .login-box button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Dashboard */
        .dashboard {
            display: none;
        }
        
        .dashboard-header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dashboard-header h1 {
            color: #333;
            font-size: 24px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .user-info {
            color: #666;
            font-size: 14px;
        }
        
        .logout-btn {
            padding: 8px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .dashboard-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            padding: 15px 30px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: #f8f9fa;
            color: #667eea;
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-left: 4px solid #764ba2;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            background: #f5f6fa;
            overflow-y: auto;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Filter Section */
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-active {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-standard {
            background: #cfe2ff;
            color: #084298;
        }
        
        .badge-gold {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        /* Lead Update Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.modal-header h2 {
    margin: 0;
    color: #333;
}

.close-modal {
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    line-height: 1;
}

.close-modal:hover {
    color: #000;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 600;
    color: #555;
    margin-bottom: 8px;
    font-size: 14px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.checkbox-group input[type="checkbox"] {
    width: auto;
    margin: 0;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.btn-info {
    background: #17a2b8;
    color: white;
}
.action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.action-buttons .btn-sm {
    white-space: nowrap;
    font-size: 11px;
    padding: 5px 10px;
}
    </style>

    <!-- jsPDF Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1>Admin Dashboard</h1>
            <p>MyAccurate Books Administration</p>
            <button onclick="adminLogin()" id="loginBtn">Login as Administrator</button>
            <div id="loginMessage" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="dashboard">
        <div class="dashboard-header">
            <h1>MyAccurate Books Dashboard</h1>
            <div class="header-actions">
                <span class="user-info">Admin User</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <div class="sidebar">
                <div class="nav-item active" onclick="showSection('overview')">
                    📊 Overview
                </div>
                <div class="nav-item" onclick="showSection('businesses')">
                    🏢 Businesses
                </div>
                <div class="nav-item" onclick="showSection('subscriptions')">
                    📋 Subscriptions
                </div>
                <div class="nav-item" onclick="showSection('payments')">
                    💰 Payments
                </div>
                <div class="nav-item" onclick="showSection('logs')">
                    📝 General Logs
                </div>
                <div class="nav-item" onclick="showSection('loginLogs')">
                    🔐 Login Logs
                </div>
                <div class="nav-item" onclick="showSection('leads')">
                    🔐 Leads
                </div>
            </div>
            
            <div class="main-content">
                <!-- Overview Section -->
                <div id="overview" class="section active">
                    <div class="card">
                        <h2>Dashboard Overview</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="overviewTotalBusinesses">-</div>
                                <div class="stat-label">Total Businesses</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="overviewActiveBusinesses">-</div>
                                <div class="stat-label">Active Businesses</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="overviewTotalRevenue">-</div>
                                <div class="stat-label">Total Revenue</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="overviewTotalPayments">-</div>
                                <div class="stat-label">Total Payments</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadOverview()">Refresh Overview</button>
                    </div>
                </div>

                <!-- Businesses Section -->
                <div id="businesses" class="section">
                    <div class="card">
                        <h2>Business Management</h2>
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>Package Type</label>
                                <select id="businessPackageFilter">
                                    <option value="">All Packages</option>
                                    <option value="1">Package 1 (Needs Follow-up)</option>
                                    <option value="2">Package 2 (Standard)</option>
                                    <option value="3">Package 3 (Gold)</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Start Date</label>
                                <input type="date" id="businessStartDate">
                            </div>
                            <div class="filter-group">
                                <label>End Date</label>
                                <input type="date" id="businessEndDate">
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="loadBusinesses()">Load Businesses</button>
                            <button class="btn btn-success" onclick="exportBusinessData('csv')">Export CSV</button>
                        </div>
                        <div id="businessMessage"></div>
                        <div id="businessStats" style="margin-top: 20px;"></div>
                        <div class="table-container">
                            <table id="businessTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Company Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Package</th>
                                        <th>Location</th>
                                        <th>Currency</th>
                                        <th>VAT</th>
                                        <th>Created Date</th>
                                    </tr>
                                </thead>
                                <tbody id="businessTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Subscriptions Section -->
                <div id="subscriptions" class="section">
                    <div class="card">
                        <h2>Subscription Analysis</h2>
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>Filter Type</label>
                                <select id="subscriptionFilter">
                                    <option value="all_active">All Active</option>
                                    <option value="expiring_today">Expiring Today</option>
                                    <option value="expiring_this_week">Expiring This Week</option>
                                    <option value="expiring_this_month">Expiring This Month</option>
                                    <option value="expired_this_month">Expired This Month</option>
                                    <option value="unpaid_only">Unpaid Only</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadSubscriptions()">Analyze Subscriptions</button>
                        <button class="btn btn-success" onclick="exportSubscriptions()" style="margin-left: 10px;">Export to Excel</button>
                        <div id="subscriptionMessage"></div>
                        <div id="subscriptionStats"></div>
                        <div class="table-container">
                            <table id="subscriptionTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Business Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Package</th>
                                        <th>Status</th>
                                        <th>Payment</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Days to Expiry</th>
                                        <th>Revenue</th>
                                    </tr>
                                </thead>
                                <tbody id="subscriptionTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Payments Section -->
               <!-- Payments Section -->
<div id="payments" class="section">
    <div class="card">
        <h2>Payment Records</h2>
        
        <!-- ADD THESE FILTER FIELDS -->
        <div class="filter-section">
            <div class="filter-group">
                <label>Start Date</label>
                <input type="date" id="paymentStartDate">
            </div>
            <div class="filter-group">
                <label>End Date</label>
                <input type="date" id="paymentEndDate">
            </div>
            <div class="filter-group">
                <label>Business Name (Search)</label>
                <input type="text" id="paymentSearchBusiness" placeholder="Search business...">
            </div>
        </div>
        
        <div class="button-group">
            <button class="btn btn-primary" onclick="loadTodayPayments()">📅 Today's Transactions</button>
            <button class="btn btn-primary" onclick="loadPayments(true)">Load Last 30 Days</button>
            <button class="btn btn-primary" onclick="loadPayments()">Load with Filters</button>
            <button class="btn btn-success" onclick="exportPayments()">Export to Excel</button>
        </div>
       
        <div id="paymentMessage"></div>
        <div id="paymentStats"></div>
        <div class="table-container">
            <table id="paymentTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Business Name</th>
                        <th>Amount</th>
                        <th>Currency</th>
                        <th>Status</th>
                        <th>Payment Method</th>
                        <th>Transaction Date</th>
                        <th>Reference Number</th>
                        <th>Phone Number</th>
                    </tr>
                </thead>
                <tbody id="paymentTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

                <!-- General Logs Section -->
                <div id="logs" class="section">
                    <div class="card">
                        <h2>General System Logs</h2>
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>Start Date & Time</label>
                                <input type="datetime-local" id="logStartDate">
                            </div>
                            <div class="filter-group">
                                <label>End Date & Time</label>
                                <input type="datetime-local" id="logEndDate">
                            </div>
                            <div class="filter-group">
                                <label>Log Type</label>
                                <input type="text" id="logType" placeholder="e.g., business_register">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadLogs()">Fetch Logs</button>
                        <button class="btn btn-success" onclick="exportLogs()" style="margin-left: 10px;">Export to Excel</button>
                        <div id="logMessage"></div>
                        <div id="logStats"></div>
                        <div class="table-container">
                            <table id="logTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Business Name</th>
                                        <th>Email</th>
                                        <th>Parent ID</th>
                                        <th>Timestamp</th>
                                        <th>Response Time</th>
                                        <th>Path</th>
                                        <th>Method</th>
                                    </tr>
                                </thead>
                                <tbody id="logTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Login Logs Section -->
                <div id="loginLogs" class="section">
                    <div class="card">
                        <h2>Login Activity Logs</h2>
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>Start Date & Time</label>
                                <input type="datetime-local" id="loginLogStartDate">
                            </div>
                            <div class="filter-group">
                                <label>End Date & Time</label>
                                <input type="datetime-local" id="loginLogEndDate">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="loadLoginLogs()">Fetch Login Logs</button>
                        <button class="btn btn-success" onclick="exportLoginLogs()" style="margin-left: 10px;">Export to Excel</button>
                        <div id="loginLogMessage"></div>
                        <div id="loginLogStats"></div>
                        <div class="table-container">
                            <table id="loginLogTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Message</th>
                                        <th>Timestamp</th>
                                        <th>IP Address</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody id="loginLogTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

               <div id="leads" class="section">
                    <div class="card">
                        <h2>Lead Management</h2>
                        
                        <!-- Filters -->
                        <div class="filter-section">
                            <div class="filter-group">
                                <label>Stage</label>
                                <select id="leadStageFilter">
                                    <option value="">All Stages</option>
                                    <option value="new">New</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="in_process">In Process</option>
                                    <option value="converted">Converted</option>
                                    <option value="recycled">Recycled</option>
                                    <option value="dead">Dead</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Start Date</label>
                                <input type="date" id="leadStartDate">
                            </div>
                            <div class="filter-group">
                                <label>End Date</label>
                                <input type="date" id="leadEndDate">
                            </div>
                            <div class="filter-group">
                                <label>Search (Name/Email/Phone)</label>
                                <input type="text" id="leadSearch" placeholder="Type to search...">
                            </div>
                        </div>

                      
                        
                     <div class="button-group">
                        <button class="btn btn-primary" onclick="loadLeads(true)">Load Last 7 Days</button>
                        <button class="btn btn-primary" onclick="loadLeads()">Load with Filters</button>
                        <button class="btn btn-success" onclick="generateLeadsPDFReport()">📊 Generate PDF Report</button>
                        <button class="btn btn-success" onclick="openImportModal()">📤 Import Leads</button>
                    </div>
                        
                        <div id="leadMessage"></div>
                        <div id="leadStats"></div>
                        
                        <div class="table-container">
                            <table id="leadTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Stage</th>
                                        <th>Assigned To</th>
                                        <th>Is Contacted</th>
                                        <th>Contacted By</th>
                                        <th>Feedback</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="leadTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Lead Update Modal -->
                <div id="leadModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Update Lead</h2>
                            <button class="close-modal" onclick="closeLeadModal()">&times;</button>
                        </div>
                        <form id="leadUpdateForm">
                            <input type="hidden" id="modalLeadId">
                            
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" id="modalLeadName" readonly style="background: #f5f5f5;">
                            </div>
                            
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="modalLeadEmail">
                            </div>
                            
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="text" id="modalLeadPhone">
                            </div>
                            
                            <div class="form-group">
                                <label>Company</label>
                                <input type="text" id="modalLeadCompany">
                            </div>
                            
                            <div class="form-group">
                                <label>Stage *</label>
                                <select id="modalLeadStage" required>
                                    <option value="new">New</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="in_process">In Process</option>
                                    <option value="converted">Converted</option>
                                    <option value="recycled">Recycled</option>
                                    <option value="dead">Dead</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Assigned To</label>
                                <input type="text" id="modalLeadAssignedTo">
                            </div>
                            
                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="modalLeadContacted">
                                <label for="modalLeadContacted" style="margin: 0;">Mark as Contacted</label>
                            </div>
                            
                            <div class="form-group">
                                <label>Contacted By</label>
                                <input type="text" id="modalLeadContactedBy">
                            </div>
                            
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="modalLeadDescription"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea id="modalLeadNotes"></textarea>
                            </div>
                            
                            <div class="form-group" id="recycledReasonGroup" style="display: none;">
                                <label>Recycled Reason</label>
                                <textarea id="modalLeadRecycledReason"></textarea>
                            </div>
                            
                            <div class="form-group" id="deadReasonGroup" style="display: none;">
                                <label>Dead Reason</label>
                                <textarea id="modalLeadDeadReason"></textarea>
                            </div>
                            
                            <div class="button-group">
                                <button type="submit" class="btn btn-primary">Update Lead</button>
                                <button type="button" class="btn btn-danger" onclick="closeLeadModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Assign Lead Modal -->
                <div id="assignModal" class="modal">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <h2>Assign Lead</h2>
                            <button class="close-modal" onclick="closeAssignModal()">&times;</button>
                        </div>
                        <form id="assignForm">
                            <input type="hidden" id="assignLeadId">
                            <div class="form-group">
                                <label>Lead Name</label>
                                <input type="text" id="assignLeadName" readonly style="background: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Assign To *</label>
                                <select id="assignToAdmin" required>
                                    <option value="">Select Admin...</option>
                                </select>
                            </div>
                            <div class="button-group">
                                <button type="submit" class="btn btn-primary">Assign Lead</button>
                                <button type="button" class="btn btn-danger" onclick="closeAssignModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Mark as Contacted Modal -->
                <div id="contactModal" class="modal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2>Mark as Contacted</h2>
                            <button class="close-modal" onclick="closeContactModal()">&times;</button>
                        </div>
                        <form id="contactForm">
                            <input type="hidden" id="contactLeadId">
                            <div class="form-group">
                                <label>Lead Name</label>
                                <input type="text" id="contactLeadName" readonly style="background: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Contacted By *</label>
                                <input type="text" id="contactedByName" required placeholder="Your name">
                            </div>
                            <div class="form-group">
                                <label>Feedback *</label>
                                <textarea id="contactFeedback" required placeholder="Enter feedback from the contact..." rows="4"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Comments</label>
                                <textarea id="contactComments" placeholder="Additional comments..." rows="3"></textarea>
                            </div>
                            <div class="button-group">
                                <button type="submit" class="btn btn-success">Save Contact Info</button>
                                <button type="button" class="btn btn-danger" onclick="closeContactModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- View Lead Details Modal -->
                <div id="viewLeadModal" class="modal">
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h2>Lead Details</h2>
                            <button class="close-modal" onclick="closeViewLeadModal()">&times;</button>
                        </div>
                        <div id="leadDetailsContent" style="line-height: 1.8;">
                            <!-- Details will be populated here -->
                        </div>
                        <div class="button-group" style="margin-top: 20px;">
                            <button class="btn btn-danger" onclick="closeViewLeadModal()">Close</button>
                        </div>
                    </div>
                </div>
                <!-- Import Leads Modal -->
                <div id="importModal" class="modal">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2>Import Leads</h2>
                            <button class="close-modal" onclick="closeImportModal()">&times;</button>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #667eea;">
                            <strong>📋 Supported Formats:</strong>
                            <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                                <li>CSV (.csv)</li>
                                <li>Excel (.xlsx, .xls)</li>
                            </ul>
                        </div>
                        
                        <form id="importForm">
                            <div class="form-group">
                                <label>Select File *</label>
                                <input type="file" id="importFileInput" accept=".csv,.xlsx,.xls" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Source *</label>
                                <select id="importSource" required>
                                    <option value="">Select Source...</option>
                                    <option value="meta">Meta (Facebook/Instagram)</option>
                                    <option value="tiktok">TikTok</option>
                                    <option value="manual">Manual Entry</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div id="importProgressDiv" style="display: none; margin: 20px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>Uploading...</span>
                                    <span id="importProgressText">0%</span>
                                </div>
                                <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                                    <div id="importProgressBar" style="background: #667eea; height: 100%; width: 0%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            
                            <div id="importResultMessage"></div>
                            
                            <div class="button-group" style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success">📤 Upload & Import</button>
                                <button type="button" class="btn btn-danger" onclick="closeImportModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://core.myaccuratebook.com';
        const AUTH_TOKEN = 'zWWq5BWO+anUMgWtimvvCguXwU=wAMnzI6grv9WkCFsIdkBydGV4SDZQQHNz';
        let adminToken = null;
        let currentBusinesses = [];

        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message message-${type}">${message}</div>`;
        }

        function clearMessage(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // Login using PHP backend
        async function adminLogin() {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            
            try {
                const response = await fetch('analyze_subscriptions.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'login'
                    })
                });

                const data = await response.json();
                
                if (data.success && data.token) {
                    adminToken = data.token;
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboardPage').style.display = 'block';
                    loadOverview();
                } else {
                    showMessage('loginMessage', 'Login failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('loginMessage', 'Login error: ' + error.message, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login as Administrator';
            }
        }

        function logout() {
            adminToken = null;
            document.getElementById('dashboardPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadOverview() {
            try {
                const [businessRes, paymentRes] = await Promise.all([
                    fetch(`${BASE_URL}/admin/business-stats?token=${adminToken}`, {
                        headers: { 'Authorization': AUTH_TOKEN }
                    }),
                    fetch(`${BASE_URL}/admin/getAllSubscriptionPaymnets?token=${adminToken}`, {
                        headers: { 'Authorization': AUTH_TOKEN }
                    })
                ]);

                const businessData = await businessRes.json();
                const paymentData = await paymentRes.json();

                document.getElementById('overviewTotalBusinesses').textContent = businessData.totalBusinesses || 0;
                document.getElementById('overviewActiveBusinesses').textContent = businessData.activeBusinesses?.count || 0;
                document.getElementById('overviewTotalRevenue').textContent = `KSH ${paymentData.data?.summary?.totalRevenue?.toLocaleString() || 0}`;
                document.getElementById('overviewTotalPayments').textContent = paymentData.data?.summary?.totalTransactions || 0;
            } catch (error) {
                console.error('Overview load error:', error);
            }
        }

        async function loadBusinesses() {
            clearMessage('businessMessage');
            showMessage('businessMessage', 'Loading businesses... This may take a moment.', 'info');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
                
                const response = await fetch(`${BASE_URL}/admin/business-stats?token=${adminToken}`, {
                    headers: { 'Authorization': AUTH_TOKEN },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Failed to load businesses');
                }

                currentBusinesses = data.activeBusinesses?.rows || [];
                
                if (currentBusinesses.length === 0) {
                    showMessage('businessMessage', 'No businesses found or API returned empty data. Check your connection.', 'error');
                    return;
                }
                
                let filtered = [...currentBusinesses];
                const packageFilter = document.getElementById('businessPackageFilter').value;
                const startDate = document.getElementById('businessStartDate').value;
                const endDate = document.getElementById('businessEndDate').value;

                if (packageFilter) {
                    filtered = filtered.filter(b => b.packageId == packageFilter);
                }

                if (startDate) {
                    filtered = filtered.filter(b => new Date(b.createdAt) >= new Date(startDate));
                }

                if (endDate) {
                    filtered = filtered.filter(b => new Date(b.createdAt) <= new Date(endDate));
                }

                displayBusinesses(filtered);
                showMessage('businessMessage', `Loaded ${filtered.length} businesses successfully`, 'success');
            } catch (error) {
                if (error.name === 'AbortError') {
                    showMessage('businessMessage', 'Request timed out. The server took too long to respond. Try again or contact support.', 'error');
                } else {
                    showMessage('businessMessage', 'Error: ' + error.message, 'error');
                }
            }
        }

        function displayBusinesses(businesses) {
            const tbody = document.getElementById('businessTableBody');
            const table = document.getElementById('businessTable');
            
            tbody.innerHTML = '';
            
            businesses.forEach(b => {
                const packageName = b.packageId === 1 ? 'Needs Follow-up' : b.packageId === 2 ? 'Standard' : 'Gold';
                const packageClass = b.packageId === 1 ? 'badge-inactive' : b.packageId === 2 ? 'badge-standard' : 'badge-gold';
                
                const row = `
                    <tr>
                        <td>${b.company_name || 'N/A'}</td>
                        <td>${b.company_email || 'N/A'}</td>
                        <td>${b.phone_number || 'N/A'}</td>
                        <td><span class="badge ${packageClass}">${packageName}</span></td>
                        <td>${b.Business_location || 'N/A'}</td>
                        <td>${b.currency || 'N/A'}</td>
                        <td>${b.is_vat ? '✓' : '✗'}</td>
                        <td>${new Date(b.createdAt).toLocaleDateString()}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            table.style.display = businesses.length > 0 ? 'table' : 'none';

            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${businesses.length}</div>
                        <div class="stat-label">Total Businesses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${businesses.filter(b => b.packageId === 2).length}</div>
                        <div class="stat-label">Standard Package</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${businesses.filter(b => b.packageId === 3).length}</div>
                        <div class="stat-label">Gold Package</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${businesses.filter(b => b.packageId === 1).length}</div>
                        <div class="stat-label">Needs Follow-up</div>
                    </div>
                </div>
            `;
            document.getElementById('businessStats').innerHTML = stats;
        }

        function exportBusinessData(format) {
            if (currentBusinesses.length === 0) {
                alert('No data to export. Please load businesses first.');
                return;
            }

            let csv = 'Company Name,Email,Phone,Package,Location,Currency,VAT,Created Date\n';
            currentBusinesses.forEach(b => {
                const packageName = b.packageId === 1 ? 'Needs Follow-up' : b.packageId === 2 ? 'Standard' : 'Gold';
                const row = [
                    b.company_name || '',
                    b.company_email || '',
                    b.phone_number || '',
                    packageName,
                    b.Business_location || '',
                    b.currency || '',
                    b.is_vat ? 'Yes' : 'No',
                    new Date(b.createdAt).toLocaleDateString()
                ];
                csv += '"' + row.join('","') + '"\n';
            });

            downloadCSV(csv, `businesses_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Global variables for export
        let currentSubscriptionData = null;
        let currentPaymentData = null;
        let currentLogData = null;
        let currentLoginLogData = null;

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportSubscriptions() {
            if (!currentSubscriptionData || !currentSubscriptionData.subscriptions) {
                alert('No subscription data to export. Please load subscriptions first.');
                return;
            }

            let csv = 'Business Name,Email,Phone,Package,Status,Payment Status,Start Date,End Date,Days to Expiry,Revenue\n';
            currentSubscriptionData.subscriptions.forEach(sub => {
                const row = [
                    sub.businessName || '',
                    sub.businessEmail || '',
                    sub.phoneNumber || '',
                    sub.packageName || '',
                    sub.subscriptionStatus || '',
                    sub.paymentStatus || '',
                    sub.startDate || '',
                    sub.endDate || '',
                    sub.daysUntilExpiry !== 'N/A' ? sub.daysUntilExpiry : '',
                    sub.revenue || '0'
                ];
                csv += '"' + row.join('","') + '"\n';
            });

            downloadCSV(csv, `subscriptions_${new Date().toISOString().split('T')[0]}.csv`);
        }
        async function exportPayments() {
    if (!adminToken) {
        alert('Not authenticated. Please login again.');
        return;
    }
    
    // Get current filter values
    const startDate = document.getElementById('paymentStartDate')?.value;
    const endDate = document.getElementById('paymentEndDate')?.value;
    
    // Build API URL with filters
    let url = `${BASE_URL}/admin/downloadSubscriptionPaymentReport?token=${adminToken}`;
    
    if (startDate && endDate) {
        url += `&startDate=${startDate}&endDate=${endDate}`;
    } else if (startDate) {
        url += `&startDate=${startDate}`;
    } else if (endDate) {
        url += `&endDate=${endDate}`;
    }
    
    try {
        // Show loading message
        showMessage('paymentMessage', 'Generating Excel report...', 'info');
        
        // Fetch the Excel file
        const response = await fetch(url, {
            headers: { 'Authorization': AUTH_TOKEN }
        });
        
        if (!response.ok) {
            throw new Error('Failed to download payment report');
        }
        
        // Get the blob
        const blob = await response.blob();
        
        // Create download link
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `Payment_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);
        
        showMessage('paymentMessage', '✅ Excel report downloaded successfully!', 'success');
    } catch (error) {
        showMessage('paymentMessage', 'Error downloading report: ' + error.message, 'error');
    }
}
        
        function exportLogs() {
            if (!currentLogData || !currentLogData.businessAnalytics) {
                alert('No log data to export. Please load logs first.');
                return;
            }

            let csv = 'Business Name,Email,Last Seen\n';
            currentLogData.businessAnalytics.forEach(b => {
                const row = [
                    b.name || '',
                    b.email || '',
                    b.lastSeenEAT || ''
                ];
                csv += '"' + row.join('","') + '"\n';
            });

            downloadCSV(csv, `logs_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportLoginLogs() {
            if (!currentLoginLogData) {
                alert('No login log data to export. Please load login logs first.');
                return;
            }

            // Parse the HTML table data
            const tbody = document.getElementById('loginLogTableBody');
            if (!tbody || tbody.children.length === 0) {
                alert('No login log data to export.');
                return;
            }

            let csv = 'Email,Status,Message,Timestamp,IP Address,Reason\n';
            Array.from(tbody.children).forEach(row => {
                const cells = row.children;
                const rowData = [
                    cells[0]?.textContent || '',
                    cells[1]?.textContent || '',
                    cells[2]?.textContent || '',
                    cells[3]?.textContent || '',
                    cells[4]?.textContent || '',
                    cells[5]?.textContent || ''
                ];
                csv += '"' + rowData.join('","') + '"\n';
            });

            downloadCSV(csv, `login_logs_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Load subscriptions using PHP backend
        async function loadSubscriptions() {
            clearMessage('subscriptionMessage');
            showMessage('subscriptionMessage', 'Analyzing subscriptions...', 'info');
            
            try {
                const filterType = document.getElementById('subscriptionFilter').value;
                
                const response = await fetch('analyze_subscriptions.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: adminToken,
                        filterType: filterType
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                displaySubscriptions(data);
                showMessage('subscriptionMessage', `Found ${data.totalSubscriptions} subscriptions`, 'success');
            } catch (error) {
                showMessage('subscriptionMessage', 'Error: ' + error.message, 'error');
            }
        }

        function displaySubscriptions(data) {
            currentSubscriptionData = data; // Store for export
            
            const tbody = document.getElementById('subscriptionTableBody');
            const table = document.getElementById('subscriptionTable');
            
            tbody.innerHTML = data.tableRows || '';
            table.style.display = data.tableRows ? 'table' : 'none';

            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.totalSubscriptions || 0}</div>
                        <div class="stat-label">Total Subscriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.paidSubscriptions || 0}</div>
                        <div class="stat-label">Paid Subscriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.unpaidSubscriptions || 0}</div>
                        <div class="stat-label">Unpaid Subscriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">KSH ${data.totalRevenue || 0}</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                </div>
            `;
            document.getElementById('subscriptionStats').innerHTML = stats;
        }

        async function loadPayments(autoLoad = false) {
        clearMessage('paymentMessage');
        showMessage('paymentMessage', 'Loading payments...', 'info');
        
        try {
            let startDate = document.getElementById('paymentStartDate')?.value;
            let endDate = document.getElementById('paymentEndDate')?.value;
            
            // Auto-load last 30 days if no dates set
            if (autoLoad && !startDate && !endDate) {
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                startDate = thirtyDaysAgo.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
                
                // Set the date inputs to show what's loaded
                document.getElementById('paymentStartDate').value = startDate;
                document.getElementById('paymentEndDate').value = endDate;
            }
            
            // Build URL with date parameters
            let url = `${BASE_URL}/admin/getAllSubscriptionPaymnets?token=${adminToken}`;
            
            if (startDate && endDate) {
                url += `&startDate=${startDate}&endDate=${endDate}`;
            } else if (startDate) {
                url += `&startDate=${startDate}`;
            } else if (endDate) {
                url += `&endDate=${endDate}`;
            }

            const response = await fetch(url, {
                headers: { 'Authorization': AUTH_TOKEN }
            });

            const data = await response.json();
            
            if (!data.success || !data.data) {
                throw new Error('Failed to load payment data');
            }
            
            displayPayments(data.data);
            
            const dateInfo = autoLoad ? ' (Last 30 days)' : '';
            showMessage('paymentMessage', `Loaded ${data.data.transactions?.length || 0} transactions successfully${dateInfo}`, 'success');
        } catch (error) {
            showMessage('paymentMessage', 'Error: ' + error.message, 'error');
        }
    }
            
        function displayPayments(paymentData) {
        
        currentPaymentData = paymentData; // Store for export
    
    const summary = paymentData.summary || {};
    
    // Display summary stats
    const stats = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">${summary.totalTransactions || 0}</div>
                <div class="stat-label">Total Transactions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">KSH ${(summary.totalRevenue || 0).toLocaleString()}</div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${summary.successfulPayments || 0}</div>
                <div class="stat-label">Successful Payments</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${summary.overallSuccessRate || '0%'}</div>
                <div class="stat-label">Success Rate</div>
            </div>
        </div>
    `;
    document.getElementById('paymentStats').innerHTML = stats;

    // Get ALL transactions from API
    let transactions = paymentData.transactions || [];
    
    // Apply client-side business name search only (dates already filtered by API)
    const searchBusiness = document.getElementById('paymentSearchBusiness')?.value?.toLowerCase();
    
    if (searchBusiness) {
        transactions = transactions.filter(t => 
            t.businessName?.toLowerCase().includes(searchBusiness)
        );
    }
    
    // Sort by transaction date (newest first)
    transactions.sort((a, b) => new Date(b.transactionDate) - new Date(a.transactionDate));

    // Display transactions in table
    const tbody = document.getElementById('paymentTableBody');
    const table = document.getElementById('paymentTable');
    
    tbody.innerHTML = '';
    
    if (transactions.length === 0) {
        showMessage('paymentMessage', 'No transactions found', 'info');
        table.style.display = 'none';
        return;
    }
    
    transactions.forEach(t => {
        const statusBadge = t.status === 'paid' ? 'badge-active' : 
                           t.status === 'pending' ? 'badge-warning' : 'badge-inactive';
        
        tbody.innerHTML += `
            <tr>
                <td>${t.businessName || 'N/A'}</td>
                <td style="font-weight: bold;">${t.currency} ${(t.amount || 0).toLocaleString()}</td>
                <td>${t.currency || 'KSH'}</td>
                <td><span class="badge ${statusBadge}">${t.status?.toUpperCase() || 'N/A'}</span></td>
                <td>${t.paymentMethod?.toUpperCase() || 'N/A'}</td>
                <td>${new Date(t.transactionDate).toLocaleString()}</td>
                <td>${t.referenceNumber || 'N/A'}</td>
                <td>${t.phoneNumber || 'N/A'}</td>
            </tr>
        `;
    });

    table.style.display = 'table';
    
    // Show filtered count if business search is active
    if (searchBusiness) {
        showMessage('paymentMessage', 
            `Showing ${transactions.length} of ${paymentData.transactions?.length || 0} transactions`, 
            'success');
    }
}
        // Load general logs using PHP backend
        async function loadLogs() {
            clearMessage('logMessage');
            
            const startDate = document.getElementById('logStartDate').value;
            const endDate = document.getElementById('logEndDate').value;
            const logType = document.getElementById('logType').value;

            if (!startDate || !endDate || !logType) {
                showMessage('logMessage', 'Please fill in all fields', 'error');
                return;
            }

            showMessage('logMessage', 'Fetching logs...', 'info');

            try {
                const formatDateTime = (dateTime) => {
                    const date = new Date(dateTime);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${year}${month}${day}${hours}${minutes}${seconds}`;
                };

                const formattedStartDate = formatDateTime(startDate);
                const formattedEndDate = formatDateTime(endDate);

                const formData = new FormData();
                formData.append('startDate', formattedStartDate);
                formData.append('endDate', formattedEndDate);
                formData.append('logType', logType);
                formData.append('token', adminToken);

                const response = await fetch('fetch_logs.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                displayLogs(data);
                showMessage('logMessage', `Found ${data.totalLogs} logs`, 'success');
            } catch (error) {
                showMessage('logMessage', 'Error: ' + error.message, 'error');
            }
        }

        function displayLogs(data) {
            currentLogData = data; // Store for export
            
            const tbody = document.getElementById('logTableBody');
            const table = document.getElementById('logTable');
            
            tbody.innerHTML = data.logRows || '';
            table.style.display = data.logRows ? 'table' : 'none';

            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.totalLogs || 0}</div>
                        <div class="stat-label">Total Logs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.uniqueUserCount || 0}</div>
                        <div class="stat-label">Unique Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.dateRange || 'N/A'}</div>
                        <div class="stat-label">Date Range</div>
                    </div>
                </div>
            `;
            document.getElementById('logStats').innerHTML = stats;
        }

        // Load login logs using PHP backend
        async function loadLoginLogs() {
            clearMessage('loginLogMessage');
            
            const startDate = document.getElementById('loginLogStartDate').value;
            const endDate = document.getElementById('loginLogEndDate').value;

            if (!startDate || !endDate) {
                showMessage('loginLogMessage', 'Please select both start and end dates', 'error');
                return;
            }

            showMessage('loginLogMessage', 'Fetching login logs...', 'info');

            try {
                const formatDateTime = (dateTime) => {
                    const date = new Date(dateTime);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${year}${month}${day}${hours}${minutes}${seconds}`;
                };

                const formattedStartDate = formatDateTime(startDate);
                const formattedEndDate = formatDateTime(endDate);

                const formData = new FormData();
                formData.append('startDate', formattedStartDate);
                formData.append('endDate', formattedEndDate);
                formData.append('token', adminToken);

                const response = await fetch('fetch_login_logs.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                displayLoginLogs(data);
                showMessage('loginLogMessage', `Found ${data.uniqueUserCount} unique users`, 'success');
            } catch (error) {
                showMessage('loginLogMessage', 'Error: ' + error.message, 'error');
            }
        }

        function displayLoginLogs(data) {
            currentLoginLogData = data; // Store for export
            
            const tbody = document.getElementById('loginLogTableBody');
            const table = document.getElementById('loginLogTable');
            
            tbody.innerHTML = data.logRows || '';
            table.style.display = data.logRows ? 'table' : 'none';

            const stats = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.uniqueUserCount || 0}</div>
                        <div class="stat-label">Unique Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.successfulLogins || 0}</div>
                        <div class="stat-label">Successful Logins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.failedLogins || 0}</div>
                        <div class="stat-label">Failed Logins</div>
                    </div>
                </div>
            `;
            document.getElementById('loginLogStats').innerHTML = stats;
        }

        // Lead Management Functions
let currentLeads = [];
let currentEditingLead = null;

async function loadLeads(autoLoad = false) {
    clearMessage('leadMessage');
    showMessage('leadMessage', 'Loading leads...', 'info');
    
    try {
        let stage = document.getElementById('leadStageFilter').value;
        let startDate = document.getElementById('leadStartDate').value;
        let endDate = document.getElementById('leadEndDate').value;
        const search = document.getElementById('leadSearch').value;
        
        // Auto-load last 7 days if no dates set
        if (autoLoad && !startDate && !endDate) {
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            startDate = sevenDaysAgo.toISOString().split('T')[0];
            endDate = today.toISOString().split('T')[0];
            
            // Set the date inputs to show what's loaded
            document.getElementById('leadStartDate').value = startDate;
            document.getElementById('leadEndDate').value = endDate;
        }
        
        const response = await fetch('leads.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'fetchLeads',
                token: adminToken,
                stage,
                startDate,
                endDate,
                search
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentLeads = data.leads || [];
        displayLeads(currentLeads, data.stats);
        
        const dateInfo = autoLoad ? ' (Last 7 days)' : '';
        showMessage('leadMessage', `Loaded ${currentLeads.length} leads successfully${dateInfo}`, 'success');
    } catch (error) {
        showMessage('leadMessage', 'Error: ' + error.message, 'error');
    }
}

function displayLeads(leads, stats) {
    const tbody = document.getElementById('leadTableBody');
    const table = document.getElementById('leadTable');
    
    tbody.innerHTML = '';
    
    if (leads.length === 0) {
        showMessage('leadMessage', 'No leads found matching your filters', 'info');
        table.style.display = 'none';
        return;
    }
    
    leads.forEach(lead => {
        const stageColors = {
            'new': 'badge-info',
            'assigned': 'badge-warning',
            'in_process': 'badge-primary',
            'converted': 'badge-active',
            'recycled': 'badge-standard',
            'dead': 'badge-inactive'
        };
        
        const stageBadge = stageColors[lead.stage] || 'badge-standard';
        
       const contactedBadge = lead.isContacted ? 
    '<span class="badge badge-active">Yes</span>' : 
    '<span class="badge badge-inactive">No</span>';
    
const feedbackPreview = lead.feedback ? 
    (lead.feedback.length > 30 ? lead.feedback.substring(0, 30) + '...' : lead.feedback) : 
    'N/A';

    const row = `
        <tr>
            <td>${lead.name || 'N/A'}</td>
            <td>${lead.email || 'N/A'}</td>
            <td>${lead.phone || 'N/A'}</td>
            <td><span class="badge ${stageBadge}">${lead.stage.replace('_', ' ').toUpperCase()}</span></td>
            <td>${lead.assignedTo || 'Unassigned'}</td>
            <td>${contactedBadge}</td>
            <td>${lead.contactedBy || 'N/A'}</td>
            <td style="font-size: 12px;">${feedbackPreview}</td>
            <td>${new Date(lead.created_at).toLocaleDateString()}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-sm btn-info" onclick='viewLeadDetails(${JSON.stringify(lead).replace(/'/g, "&apos;")})'>
                        👁️ View
                    </button>
                    <button class="btn btn-sm btn-warning" onclick='openAssignModal("${lead.id}", "${lead.name}")'>
                        Assign
                    </button>
                    <button class="btn btn-sm btn-success" onclick='openContactModal("${lead.id}", "${lead.name}")'>
                        Contact
                    </button>
                    <button class="btn btn-sm btn-primary" onclick='quickUpdateStage("${lead.id}", "converted")'>
                        Convert
                    </button>
                </div>
            </td>
        </tr>
    `;
        
    tbody.innerHTML += row;
    });
    
    table.style.display = 'table';
    
    // Display stats
    const statsHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">${stats.total}</div>
                <div class="stat-label">Total Leads</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.new}</div>
                <div class="stat-label">New</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.converted}</div>
                <div class="stat-label">Converted</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${stats.contacted}</div>
                <div class="stat-label">Contacted</div>
            </div>
        </div>
    `;
    document.getElementById('leadStats').innerHTML = statsHTML;
}

function openLeadModal(lead) {
    currentEditingLead = lead;
    
    document.getElementById('modalLeadId').value = lead.id;
    document.getElementById('modalLeadName').value = lead.name || '';
    document.getElementById('modalLeadEmail').value = lead.email || '';
    document.getElementById('modalLeadPhone').value = lead.phone || '';
    document.getElementById('modalLeadCompany').value = lead.company || '';
    document.getElementById('modalLeadStage').value = lead.stage;
    document.getElementById('modalLeadAssignedTo').value = lead.assignedTo || '';
    document.getElementById('modalLeadContacted').checked = lead.isContacted;
    document.getElementById('modalLeadContactedBy').value = lead.contactedBy || '';
    document.getElementById('modalLeadDescription').value = lead.description || '';
    document.getElementById('modalLeadNotes').value = lead.notes || '';
    document.getElementById('modalLeadRecycledReason').value = lead.recycledReason || '';
    document.getElementById('modalLeadDeadReason').value = lead.deadReason || '';
    
    toggleReasonFields(lead.stage);
    
    document.getElementById('leadModal').style.display = 'block';
}

function closeLeadModal() {
    document.getElementById('leadModal').style.display = 'none';
    currentEditingLead = null;
}

// Show/hide reason fields based on stage
document.getElementById('modalLeadStage').addEventListener('change', function() {
    toggleReasonFields(this.value);
});

function toggleReasonFields(stage) {
    document.getElementById('recycledReasonGroup').style.display = 
        stage === 'recycled' ? 'block' : 'none';
    document.getElementById('deadReasonGroup').style.display = 
        stage === 'dead' ? 'block' : 'none';
}

// Handle form submission
document.getElementById('leadUpdateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const leadId = document.getElementById('modalLeadId').value;
    const updateData = {
        email: document.getElementById('modalLeadEmail').value,
        phone: document.getElementById('modalLeadPhone').value,
        company: document.getElementById('modalLeadCompany').value,
        stage: document.getElementById('modalLeadStage').value,
        assignedTo: document.getElementById('modalLeadAssignedTo').value,
        isContacted: document.getElementById('modalLeadContacted').checked,
        contactedBy: document.getElementById('modalLeadContactedBy').value,
        description: document.getElementById('modalLeadDescription').value,
        notes: document.getElementById('modalLeadNotes').value
    };
    
    if (updateData.stage === 'recycled') {
        updateData.recycledReason = document.getElementById('modalLeadRecycledReason').value;
    }
    
    if (updateData.stage === 'dead') {
        updateData.deadReason = document.getElementById('modalLeadDeadReason').value;
    }
    
    try {
        const response = await fetch('leads.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'updateLead',
                token: adminToken,
                leadId: leadId,
                data: updateData
            })
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Error updating lead: ' + result.error);
        } else {
            alert('Lead updated successfully!');
            closeLeadModal();
            loadLeads(); // Reload leads
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Quick update stage (inline button)
async function quickUpdateStage(leadId, newStage) {
    if (!confirm(`Are you sure you want to mark this lead as ${newStage}?`)) {
        return;
    }
    
    try {
        const response = await fetch('leads.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'updateLead',
                token: adminToken,
                leadId: leadId,
                data: { stage: newStage }
            })
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            showMessage('leadMessage', 'Lead updated successfully!', 'success');
            loadLeads(); // Reload leads
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Generate comprehensive PDF Report
function generateLeadsPDFReport() {
    if (currentLeads.length === 0) {
        alert('No leads to export. Please load leads first.');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // Calculate statistics
    const stats = calculateLeadStatistics(currentLeads);
    
    let yPos = 20;
    
    // Header
    doc.setFillColor(102, 126, 234);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(24);
    doc.setFont(undefined, 'bold');
    doc.text('Lead Management Report', 105, 20, { align: 'center' });
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 30, { align: 'center' });
    
    yPos = 50;
    doc.setTextColor(0, 0, 0);
    
    // Executive Summary
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(102, 126, 234);
    doc.text('Executive Summary', 14, yPos);
    yPos += 10;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    
    // Summary stats in a grid
    const summaryData = [
        ['Total Leads', stats.total.toString()],
        ['Contacted', stats.contacted.toString()],
        ['Converted', stats.converted.toString()],
        ['Conversion Rate', `${stats.conversionRate}%`]
    ];
    
    doc.autoTable({
        startY: yPos,
        head: [['Metric', 'Value']],
        body: summaryData,
        theme: 'grid',
        headStyles: { fillColor: [102, 126, 234], fontSize: 10, fontStyle: 'bold' },
        columnStyles: { 0: { fontStyle: 'bold' } },
        margin: { left: 14, right: 14 }
    });
    
    yPos = doc.lastAutoTable.finalY + 15;
    
    // Lead Stage Breakdown
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(102, 126, 234);
    doc.text('Lead Stage Breakdown', 14, yPos);
    yPos += 10;
    
    const stageData = [
        ['New', stats.byStage.new || 0],
        ['Assigned', stats.byStage.assigned || 0],
        ['In Process', stats.byStage.in_process || 0],
        ['Converted', stats.byStage.converted || 0],
        ['Recycled', stats.byStage.recycled || 0],
        ['Dead', stats.byStage.dead || 0]
    ];
    
    doc.autoTable({
        startY: yPos,
        head: [['Stage', 'Count']],
        body: stageData,
        theme: 'striped',
        headStyles: { fillColor: [102, 126, 234], fontSize: 10, fontStyle: 'bold' },
        margin: { left: 14, right: 14 }
    });
    
    yPos = doc.lastAutoTable.finalY + 15;
    
    // Check if we need a new page
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }
    
    // Performance by Admin
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(102, 126, 234);
    doc.text('Performance by Admin', 14, yPos);
    yPos += 10;
    
    const adminPerformance = stats.byAdmin;
    const adminData = Object.keys(adminPerformance).map(admin => {
        const perf = adminPerformance[admin];
        return [
            admin,
            perf.total,
            perf.contacted,
            perf.converted,
            `${perf.contactedRate}%`,
            `${perf.conversionRate}%`
        ];
    });
    
    if (adminData.length > 0) {
        doc.autoTable({
            startY: yPos,
            head: [['Admin Name', 'Total', 'Contacted', 'Converted', 'Contact Rate', 'Conv. Rate']],
            body: adminData,
            theme: 'grid',
            headStyles: { fillColor: [102, 126, 234], fontSize: 9, fontStyle: 'bold' },
            styles: { fontSize: 8 },
            columnStyles: {
                0: { cellWidth: 50 },
                1: { cellWidth: 20, halign: 'center' },
                2: { cellWidth: 25, halign: 'center' },
                3: { cellWidth: 25, halign: 'center' },
                4: { cellWidth: 28, halign: 'center' },
                5: { cellWidth: 28, halign: 'center' }
            },
            margin: { left: 14, right: 14 }
        });
        
        yPos = doc.lastAutoTable.finalY + 15;
    } else {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(150, 150, 150);
        doc.text('No admin assignments found', 14, yPos);
        yPos += 15;
    }
    
    // Check if we need a new page
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }
    
    // Recent Activity - Contacted Leads
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(102, 126, 234);
    doc.text('Recently Contacted Leads', 14, yPos);
    yPos += 10;
    
    const contactedLeads = currentLeads
        .filter(lead => lead.isContacted)
        .sort((a, b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at))
        .slice(0, 10);
    
    if (contactedLeads.length > 0) {
        const contactedData = contactedLeads.map(lead => [
            lead.name || 'N/A',
            lead.email || 'N/A',
            lead.contactedBy || 'N/A',
            lead.stage.replace('_', ' ').toUpperCase(),
            (lead.feedback || '').substring(0, 40) + (lead.feedback?.length > 40 ? '...' : '')
        ]);
        
        doc.autoTable({
            startY: yPos,
            head: [['Name', 'Email', 'Contacted By', 'Stage', 'Feedback']],
            body: contactedData,
            theme: 'striped',
            headStyles: { fillColor: [40, 167, 69], fontSize: 8, fontStyle: 'bold' },
            styles: { fontSize: 7 },
            columnStyles: {
                0: { cellWidth: 35 },
                1: { cellWidth: 45 },
                2: { cellWidth: 30 },
                3: { cellWidth: 25 },
                4: { cellWidth: 45 }
            },
            margin: { left: 14, right: 14 }
        });
        
        yPos = doc.lastAutoTable.finalY + 15;
    } else {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(150, 150, 150);
        doc.text('No contacted leads found', 14, yPos);
        yPos += 15;
    }
    
    // Check if we need a new page for converted leads
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }
    
    // Converted Leads
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(102, 126, 234);
    doc.text('Converted Leads', 14, yPos);
    yPos += 10;
    
    const convertedLeads = currentLeads
        .filter(lead => lead.stage === 'converted')
        .sort((a, b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at))
        .slice(0, 15);
    
    if (convertedLeads.length > 0) {
        const convertedData = convertedLeads.map(lead => [
            lead.name || 'N/A',
            lead.email || 'N/A',
            lead.phone || 'N/A',
            lead.assignedTo || 'Unassigned',
            new Date(lead.created_at).toLocaleDateString()
        ]);
        
        doc.autoTable({
            startY: yPos,
            head: [['Name', 'Email', 'Phone', 'Converted By', 'Date']],
            body: convertedData,
            theme: 'grid',
            headStyles: { fillColor: [40, 167, 69], fontSize: 9, fontStyle: 'bold' },
            styles: { fontSize: 8 },
            margin: { left: 14, right: 14 }
        });
    } else {
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(150, 150, 150);
        doc.text('No converted leads found', 14, yPos);
    }
    
    // Footer on all pages
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(
            `Page ${i} of ${pageCount} | MyAccurate Books - Lead Management System`,
            105,
            290,
            { align: 'center' }
        );
    }
    
    // Save the PDF
    const filename = `Lead_Report_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
    
    showMessage('leadMessage', '✅ PDF Report generated successfully!', 'success');
}

// Import Leads from File
async function importLeadsFile() {
    const fileInput = document.getElementById('leadFileInput');
    const sourceSelect = document.getElementById('leadSource');
    const importMessage = document.getElementById('importMessage');
    const progressDiv = document.getElementById('importProgress');
    const progressBar = document.getElementById('importProgressBar');
    const progressText = document.getElementById('importProgressText');
    
    // Clear previous messages
    importMessage.innerHTML = '';
    
    // Validate inputs
    if (!fileInput.files || fileInput.files.length === 0) {
        importMessage.innerHTML = '<div class="message message-error" style="color: white; background: rgba(220, 53, 69, 0.3); border-color: rgba(220, 53, 69, 0.5);">Please select a file to upload</div>';
        return;
    }
    
    const source = sourceSelect.value;
    if (!source) {
        importMessage.innerHTML = '<div class="message message-error" style="color: white; background: rgba(220, 53, 69, 0.3); border-color: rgba(220, 53, 69, 0.5);">Please select a source (Meta or TikTok)</div>';
        return;
    }
    
    const file = fileInput.files[0];
    
    // Validate file type
    const fileName = file.name.toLowerCase();
    if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
        importMessage.innerHTML = '<div class="message message-error" style="color: white; background: rgba(220, 53, 69, 0.3); border-color: rgba(220, 53, 69, 0.5);">Invalid file type. Please upload a CSV or Excel file (.csv, .xlsx, .xls)</div>';
        return;
    }
    
    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        importMessage.innerHTML = '<div class="message message-error" style="color: white; background: rgba(220, 53, 69, 0.3); border-color: rgba(220, 53, 69, 0.5);">File is too large. Maximum size is 10MB</div>';
        return;
    }
    
    // Show progress
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = '0%';
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('source', source);
        formData.append('token', adminToken);
        
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += 10;
                progressBar.style.width = progress + '%';
                progressText.textContent = progress + '%';
            }
        }, 200);
        
        const response = await fetch('import_leads.php', {
            method: 'POST',
            body: formData
        });
        
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        // Show success message
        let successHTML = `
            <div class="message message-success" style="color: white; background: rgba(40, 167, 69, 0.3); border-color: rgba(40, 167, 69, 0.5);">
                <strong>✅ Import Successful!</strong><br>
                <div style="margin-top: 10px; line-height: 1.8;">
                    📊 Source: <strong>${result.source.toUpperCase()}</strong><br>
                    📝 Total Parsed: <strong>${result.totalParsed}</strong><br>
                    ✅ Successfully Imported: <strong>${result.totalImported}</strong><br>
                    ${result.totalErrors > 0 ? `❌ Errors: <strong>${result.totalErrors}</strong>` : ''}
                </div>
            </div>
        `;
        
        // Show sample errors if any
        if (result.sampleErrors && result.sampleErrors.length > 0) {
            successHTML += `
                <div style="margin-top: 10px; padding: 10px; background: rgba(255,193,7,0.2); border-radius: 6px;">
                    <strong>⚠️ Sample Errors (first 5):</strong>
                    <ul style="margin-top: 5px; padding-left: 20px;">
            `;
            result.sampleErrors.slice(0, 5).forEach(err => {
                successHTML += `<li>Row ${err.index + 1}: ${JSON.stringify(err.issues).substring(0, 100)}...</li>`;
            });
            successHTML += `</ul></div>`;
        }
        
        importMessage.innerHTML = successHTML;
        
        // Clear file input
        fileInput.value = '';
        
        // Hide progress after 2 seconds
        setTimeout(() => {
            progressDiv.style.display = 'none';
        }, 2000);
        
        // Reload leads if on leads page
        setTimeout(() => {
            loadLeads(true);
        }, 2500);
        
    } catch (error) {
        progressDiv.style.display = 'none';
        importMessage.innerHTML = `
            <div class="message message-error" style="color: white; background: rgba(220, 53, 69, 0.3); border-color: rgba(220, 53, 69, 0.5);">
                <strong>❌ Import Failed</strong><br>
                ${error.message}
            </div>
        `;
    }
}

// Helper function to show import tips
function showImportTips() {
    const tips = `
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
            <strong>📋 Import Tips:</strong>
            <ul style="margin-top: 10px; padding-left: 20px; line-height: 1.8;">
                <li><strong>Meta/Facebook:</strong> Should contain columns like "Full name", "Email", "Phone number"</li>
                <li><strong>TikTok:</strong> Should contain columns matching TikTok's lead export format</li>
                <li>Maximum file size: <strong>10MB</strong></li>
                <li>Supported formats: <strong>.csv, .xlsx, .xls</strong></li>
                <li>Duplicate emails will be updated with new information</li>
            </ul>
        </div>
    `;
    return tips;
}
// Calculate comprehensive statistics
function calculateLeadStatistics(leads) {
    const stats = {
        total: leads.length,
        contacted: 0,
        converted: 0,
        byStage: {},
        byAdmin: {}
    };
    
    leads.forEach(lead => {
        // Count contacted
        if (lead.isContacted) stats.contacted++;
        
        // Count by stage
        if (!stats.byStage[lead.stage]) {
            stats.byStage[lead.stage] = 0;
        }
        stats.byStage[lead.stage]++;
        
        // Count converted
        if (lead.stage === 'converted') stats.converted++;
        
        // Count by admin
        const adminName = lead.assignedTo || 'Unassigned';
        if (!stats.byAdmin[adminName]) {
            stats.byAdmin[adminName] = {
                total: 0,
                contacted: 0,
                converted: 0
            };
        }
        stats.byAdmin[adminName].total++;
        if (lead.isContacted) stats.byAdmin[adminName].contacted++;
        if (lead.stage === 'converted') stats.byAdmin[adminName].converted++;
    });
    
    // Calculate rates
    stats.conversionRate = stats.total > 0 ? 
        ((stats.converted / stats.total) * 100).toFixed(1) : '0.0';
    
    // Calculate admin rates
    Object.keys(stats.byAdmin).forEach(admin => {
        const adminStats = stats.byAdmin[admin];
        adminStats.contactedRate = adminStats.total > 0 ?
            ((adminStats.contacted / adminStats.total) * 100).toFixed(1) : '0.0';
        adminStats.conversionRate = adminStats.total > 0 ?
            ((adminStats.converted / adminStats.total) * 100).toFixed(1) : '0.0';
    });
    
    return stats;
}
// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('leadModal');
    if (event.target === modal) {
        closeLeadModal();
    }
};

// Auto-load leads when navigating to leads section
document.addEventListener('DOMContentLoaded', function() {
    // Listen for navigation to leads section
    const leadsNavItem = document.querySelector('.nav-item[onclick*="leads"]');
    if (leadsNavItem) {
        const originalOnClick = leadsNavItem.onclick;
        leadsNavItem.onclick = function(e) {
            originalOnClick.call(this, e);
            
            // Check if leads haven't been loaded yet
            if (currentLeads.length === 0 && adminToken) {
                setTimeout(() => {
                    loadLeads(true); // true = auto-load mode
                }, 100);
            }
        };
    }
});

// Global variable for admins
let adminsList = [];

// Load admins list on page load
async function loadAdmins() {
    try {
        const response = await fetch('leads.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'getAdmins',
                token: adminToken
            })
        });
        
        const data = await response.json();
        if (data.admins) {
            adminsList = data.admins;
            populateAdminDropdown();
        }
    } catch (error) {
        console.error('Error loading admins:', error);
    }
}

function populateAdminDropdown() {
    const select = document.getElementById('assignToAdmin');
    select.innerHTML = '<option value="">Select Admin...</option>';
    
    adminsList.forEach(admin => {
        const option = document.createElement('option');
        option.value = admin.name;
        option.textContent = `${admin.name} (${admin.email})`;
        select.appendChild(option);
    });
}

// Assign Modal Functions
function openAssignModal(leadId, leadName) {
    document.getElementById('assignLeadId').value = leadId;
    document.getElementById('assignLeadName').value = leadName;
    document.getElementById('assignModal').style.display = 'block';
    
    if (adminsList.length === 0) {
        loadAdmins();
    }
}

function closeAssignModal() {
    document.getElementById('assignModal').style.display = 'none';
    document.getElementById('assignForm').reset();
}

document.getElementById('assignForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const leadId = document.getElementById('assignLeadId').value;
    const assignTo = document.getElementById('assignToAdmin').value;
    
    try {
        const response = await fetch('leads.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'updateLead',
                token: adminToken,
                leadId: leadId,
                data: { 
                    assignedTo: assignTo,
                    stage: 'assigned'
                }
            })
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Error assigning lead: ' + result.error);
        } else {
            alert('Lead assigned successfully!');
            closeAssignModal();
            loadLeads();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Contact Modal Functions
function openContactModal(leadId, leadName) {
    document.getElementById('contactLeadId').value = leadId;
    document.getElementById('contactLeadName').value = leadName;
    document.getElementById('contactModal').style.display = 'block';
}

function closeContactModal() {
    document.getElementById('contactModal').style.display = 'none';
    document.getElementById('contactForm').reset();
}

document.getElementById('contactForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const leadId = document.getElementById('contactLeadId').value;
    const contactedBy = document.getElementById('contactedByName').value;
    const feedback = document.getElementById('contactFeedback').value;
    const comments = document.getElementById('contactComments').value;
    
    try {
        const response = await fetch('leads.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'updateLead',
                token: adminToken,
                leadId: leadId,
                data: { 
                    isContacted: true,
                    contactedBy: contactedBy,
                    feedback: feedback,
                    notes: comments
                }
            })
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Error updating contact info: ' + result.error);
        } else {
            alert('Contact information saved successfully!');
            closeContactModal();
            loadLeads();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// View Lead Details
function viewLeadDetails(lead) {
    const contactedStatus = lead.isContacted ? 
        '<span class="badge badge-active">Yes</span>' : 
        '<span class="badge badge-inactive">No</span>';
    
    const detailsHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h3 style="color: #667eea; margin-bottom: 15px;">Basic Information</h3>
                <p><strong>Name:</strong> ${lead.name || 'N/A'}</p>
                <p><strong>Email:</strong> ${lead.email || 'N/A'}</p>
                <p><strong>Phone:</strong> ${lead.phone || 'N/A'}</p>
                <p><strong>Company:</strong> ${lead.company || 'N/A'}</p>
                <p><strong>Source:</strong> ${lead.source || 'N/A'}</p>
                <p><strong>Campaign:</strong> ${lead.campaignName || 'N/A'}</p>
            </div>
            <div>
                <h3 style="color: #667eea; margin-bottom: 15px;">Status & Assignment</h3>
                <p><strong>Stage:</strong> ${lead.stage.replace('_', ' ').toUpperCase()}</p>
                <p><strong>Assigned To:</strong> ${lead.assignedTo || 'Unassigned'}</p>
                <p><strong>Is Contacted:</strong> ${contactedStatus}</p>
                <p><strong>Contacted By:</strong> ${lead.contactedBy || 'N/A'}</p>
                <p><strong>Created:</strong> ${new Date(lead.created_at).toLocaleString()}</p>
                <p><strong>Last Updated:</strong> ${lead.updated_at ? new Date(lead.updated_at).toLocaleString() : 'N/A'}</p>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Description</h3>
            <p style="background: #f5f5f5; padding: 10px; border-radius: 6px;">${lead.description || 'No description available'}</p>
        </div>
        <div style="margin-top: 15px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Feedback</h3>
            <p style="background: #f5f5f5; padding: 10px; border-radius: 6px;">${lead.feedback || 'No feedback yet'}</p>
        </div>
        <div style="margin-top: 15px;">
            <h3 style="color: #667eea; margin-bottom: 10px;">Notes</h3>
            <p style="background: #f5f5f5; padding: 10px; border-radius: 6px;">${lead.notes || 'No notes'}</p>
        </div>
        ${lead.recycledReason ? `
        <div style="margin-top: 15px;">
            <h3 style="color: #ffc107; margin-bottom: 10px;">Recycled Reason</h3>
            <p style="background: #fff3cd; padding: 10px; border-radius: 6px;">${lead.recycledReason}</p>
        </div>` : ''}
        ${lead.deadReason ? `
        <div style="margin-top: 15px;">
            <h3 style="color: #dc3545; margin-bottom: 10px;">Dead Reason</h3>
            <p style="background: #f8d7da; padding: 10px; border-radius: 6px;">${lead.deadReason}</p>
        </div>` : ''}
    `;
    
    document.getElementById('leadDetailsContent').innerHTML = detailsHTML;
    document.getElementById('viewLeadModal').style.display = 'block';
}

// Import Modal Functions
function openImportModal() {
    document.getElementById('importModal').style.display = 'block';
    document.getElementById('importForm').reset();
    document.getElementById('importResultMessage').innerHTML = '';
    document.getElementById('importProgressDiv').style.display = 'none';
}

function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
}

// Handle Import Form Submission
document.getElementById('importForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('importFileInput');
    const source = document.getElementById('importSource').value;
    const resultMessage = document.getElementById('importResultMessage');
    const progressDiv = document.getElementById('importProgressDiv');
    const progressBar = document.getElementById('importProgressBar');
    const progressText = document.getElementById('importProgressText');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        resultMessage.innerHTML = '<div class="message message-error">Please select a file</div>';
        return;
    }
    
    const file = fileInput.files[0];
    
    // Validate file type
    const fileName = file.name.toLowerCase();
    if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
        resultMessage.innerHTML = '<div class="message message-error">Invalid file type. Please upload CSV or Excel file</div>';
        return;
    }
    
    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        resultMessage.innerHTML = '<div class="message message-error">File too large. Maximum size is 10MB</div>';
        return;
    }
    
    // Show progress
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = '0%';
    resultMessage.innerHTML = '';
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('source', source);
        formData.append('token', adminToken);
        
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += 10;
                progressBar.style.width = progress + '%';
                progressText.textContent = progress + '%';
            }
        }, 200);
        
        const response = await fetch('import_leads.php', {
            method: 'POST',
            body: formData
        });
        
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressText.textContent = '100%';
        
        const result = await response.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        // Show success message
        let successHTML = `
            <div class="message message-success">
                <strong>✅ Import Successful!</strong><br>
                <div style="margin-top: 10px; line-height: 1.8;">
                    📊 Source: <strong>${result.source.toUpperCase()}</strong><br>
                    📝 Total Parsed: <strong>${result.totalParsed}</strong><br>
                    ✅ Successfully Imported: <strong>${result.totalImported}</strong><br>
                    ${result.totalErrors > 0 ? `❌ Errors: <strong>${result.totalErrors}</strong>` : ''}
                </div>
            </div>
        `;
        
        resultMessage.innerHTML = successHTML;
        
        // Clear file input
        fileInput.value = '';
        
        // Reload leads after 2 seconds
        setTimeout(() => {
            closeImportModal();
            loadLeads(true);
        }, 2000);
        
    } catch (error) {
        progressDiv.style.display = 'none';
        resultMessage.innerHTML = `
            <div class="message message-error">
                <strong>❌ Import Failed</strong><br>
                ${error.message}
            </div>
        `;
    }
});
function closeViewLeadModal() {
    document.getElementById('viewLeadModal').style.display = 'none';
}

// Update window.onclick to handle all modals
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
};

// Auto-load payments when navigating to payments section
document.addEventListener('DOMContentLoaded', function() {
    // Store reference to current payments data
    let paymentsLoaded = false;
    
    // Get all nav items
    const navItems = document.querySelectorAll('.nav-item');
    
    navItems.forEach(item => {
        item.addEventListener('click', function() {
            const sectionName = this.textContent.trim();
            
            // Auto-load last 30 days when payments section is opened
            if (sectionName.includes('Payments') && !paymentsLoaded && adminToken) {
                setTimeout(() => {
                    loadPayments(true); // true = auto-load mode (last 30 days)
                    paymentsLoaded = true;
                }, 100);
            }
        });
    });
});

// Quick load today's payments
function loadTodayPayments() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('paymentStartDate').value = today;
    document.getElementById('paymentEndDate').value = today;
    loadPayments();
}
    </script>
</body>
</html>